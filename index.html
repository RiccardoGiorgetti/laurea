<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Run Riccardo Run</title>
    <style>
        /* STILE GENERALE */
        body { margin: 0; overflow: hidden; background-color: #111; font-family: 'Verdana', sans-serif; touch-action: none; user-select: none; }
        
        #game-container { position: relative; width: 100vw; height: 100vh; background: linear-gradient(180deg, #222 0%, #000 100%); overflow: hidden; }
        
        canvas { display: block; width: 100%; height: 100%; }

        /* HUD PUNTEGGIO */
        #score-hud {
            position: absolute; top: 20px; right: 20px;
            color: #00ff41; font-size: 28px; font-weight: bold; font-family: 'Courier New', monospace;
            z-index: 10; text-shadow: 0 0 10px rgba(0,255,65,0.5);
        }

        /* MENU E SCHERMATE */
        .ui-layer { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            display: flex; flex-direction: column; align-items: center; justify-content: center; 
            z-index: 30; background: rgba(0,0,0,0.85); backdrop-filter: blur(5px); 
        }
        
        h1 { color: #fff; font-size: 32px; text-transform: uppercase; margin-bottom: 10px; text-align: center; }
        p { color: #ccc; margin-bottom: 20px; text-align: center; font-size: 14px; max-width: 90%; }
        
        /* CONTROLLI MOBILE (Visibili solo durante il gioco) */
        #mobile-controls {
            position: absolute; bottom: 20px; left: 0; width: 100%;
            display: flex; justify-content: space-around; padding: 0 20px; box-sizing: border-box;
            z-index: 20; display: none; /* Nascosti nel menu */
        }

        .control-btn {
            width: 120px; height: 80px;
            border-radius: 15px; border: 2px solid #555;
            background: rgba(255,255,255,0.1);
            color: white; font-size: 20px; font-weight: bold;
            display: flex; align-items: center; justify-content: center;
            user-select: none; -webkit-user-select: none;
        }
        .control-btn:active { background: rgba(0,255,65,0.3); border-color: #00ff41; transform: scale(0.95); }

        /* BOTTONI MENU */
        .menu-btn { 
            background: #00ff41; border: none; padding: 15px 40px; color: #000; 
            font-size: 20px; font-weight: bold; border-radius: 50px; cursor: pointer; 
            box-shadow: 0 0 15px rgba(0, 255, 65, 0.4); text-transform: uppercase; margin-top: 10px;
        }

        .hidden { display: none !important; }

        input { padding: 15px; font-size: 18px; text-align: center; border-radius: 10px; border: 2px solid #333; background: #222; color: white; margin-bottom: 20px; width: 70%; max-width: 300px; }

        /* CLASSIFICA */
        #leaderboard-box { 
            background: rgba(255,255,255,0.08); width: 90%; max-width: 400px; 
            padding: 15px; border-radius: 15px; max-height: 200px; overflow-y: auto; 
            text-align: left; border: 1px solid #333; margin-top: 20px;
        }
        .row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #444; color: #ccc; font-size: 14px; font-family: monospace; }
        .row:first-child { color: #ffd700; font-weight: bold; } 
    </style>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getDatabase, ref, push, query, orderByChild, limitToLast, onValue } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";

        // --- INCOLLA QUI LA TUA CONFIGURAZIONE FIREBASE ---
        const firebaseConfig = {
            apiKey: "INCOLLA_LA_TUA_API_KEY",
            authDomain: "TUO-PROGETTO.firebaseapp.com",
            projectId: "TUO-PROGETTO",
            storageBucket: "TUO-PROGETTO.appspot.com",
            messagingSenderId: "NUMERO",
            appId: "CODICE_APP"
        };
        // --------------------------------------------------

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        window.saveScoreToDb = function(name, score) {
            const btn = document.getElementById('btn-save');
            btn.innerText = "Salvataggio..."; btn.disabled = true;
            push(ref(db, 'scores_dino'), { name: name, score: score, date: Date.now() })
            .then(() => location.reload())
            .catch((e) => { alert("Errore: " + e); btn.disabled = false; });
        };

        window.loadLeaderboard = function() {
            const q = query(ref(db, 'scores_dino'), orderByChild('score'), limitToLast(10));
            onValue(q, (snapshot) => {
                const list = document.getElementById('lb-list');
                list.innerHTML = "";
                let data = [];
                snapshot.forEach(c => data.push(c.val()));
                data.sort((a,b) => b.score - a.score); 
                if(data.length === 0) list.innerHTML = "<div style='text-align:center; padding:10px;'>Nessun record</div>";
                data.forEach((entry, i) => {
                    const d = document.createElement('div');
                    d.className = 'row';
                    let safeName = entry.name ? entry.name.substring(0, 12) : "Anonimo";
                    d.innerHTML = `<span>${i+1}. ${safeName}</span><span>${entry.score}</span>`;
                    list.appendChild(d);
                });
            });
        };
        loadLeaderboard();
    </script>
</head>
<body>

    <div id="score-hud">0</div>

    <div id="game-container">
        <canvas id="gameCanvas"></canvas>

        <div id="start-screen" class="ui-layer">
            <h1>LAUREA RUN</h1>
            <p>Salta gli ostacoli a terra.<br>Abbassati per quelli in aria.</p>
            <button class="menu-btn" onclick="startGame()">GIOCA</button>
            <div id="leaderboard-box">
                <div style="text-align:center; color:#00ff41; border-bottom:1px solid #444; margin-bottom:10px; padding-bottom:5px; font-weight:bold;">üèÜ TOP 10</div>
                <div id="lb-list">Caricamento...</div>
            </div>
        </div>

        <div id="lose-screen" class="ui-layer hidden">
            <h1 style="color:#ff3333;">GAME OVER</h1>
            <p style="font-size: 20px; color: white;">Punteggio: <span id="final-score" style="font-weight:bold; color:#00ff41">0</span></p>
            <input type="text" id="player-name" placeholder="IL TUO NOME" maxlength="10">
            <button id="btn-save" class="menu-btn" onclick="submitScore()">SALVA</button>
            <button onclick="resetGame()" style="background:transparent; border:1px solid #555; color:#aaa; font-size:14px; padding:10px 20px; margin-top:15px; border-radius: 20px;">Rigioca</button>
        </div>

        <div id="mobile-controls">
            <div class="control-btn" id="btn-crouch" ontouchstart="startCrouch(event)" ontouchend="stopCrouch(event)">‚¨áÔ∏è GI√ô</div>
            <div class="control-btn" id="btn-jump" ontouchstart="doJump(event)">‚¨ÜÔ∏è SALTA</div>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const imgFace = new Image();
        imgFace.src = 'face.png'; // La tua faccia

        function resize() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }
        window.addEventListener('resize', resize);
        resize();

        // CONFIGURAZIONE
        const GRAVITY = 0.8;
        const JUMP_FORCE = -14; 
        const GROUND_HEIGHT = 50;
        let speed = 6;
        
        let state = {
            running: false,
            score: 0,
            frameCount: 0,
            player: { 
                x: 50, y: 0, dy: 0, 
                w: 50, h: 50, // Dimensione normale
                originalH: 50, 
                grounded: false, 
                crouching: false 
            },
            obstacles: []
        };

        // CONTROLLI (Tastiera + Touch)
        function doJump(e) {
            if(e) e.preventDefault();
            if(state.running && state.player.grounded) {
                state.player.dy = JUMP_FORCE;
                state.player.grounded = false;
                // Se salto, smetto di abbassarmi
                state.player.crouching = false;
                state.player.h = state.player.originalH; 
            }
        }

        function startCrouch(e) {
            if(e) e.preventDefault();
            if(state.running && state.player.grounded) {
                state.player.crouching = true;
                state.player.h = state.player.originalH / 2; // Diventa met√† altezza
                state.player.y += state.player.originalH / 2; // Sposta gi√π visivamente
            }
        }

        function stopCrouch(e) {
            if(e) e.preventDefault();
            if(state.running && state.player.crouching) {
                state.player.crouching = false;
                state.player.y -= state.player.originalH / 2; // Torna su
                state.player.h = state.player.originalH;
            }
        }

        // Event Listeners PC
        window.addEventListener('keydown', (e) => {
            if(e.code === 'ArrowUp' || e.code === 'Space') doJump();
            if(e.code === 'ArrowDown') startCrouch();
        });
        window.addEventListener('keyup', (e) => {
            if(e.code === 'ArrowDown') stopCrouch();
        });

        // Event Listeners Mouse (per test su PC coi bottoni)
        document.getElementById('btn-jump').addEventListener('mousedown', (e) => doJump(e));
        document.getElementById('btn-crouch').addEventListener('mousedown', (e) => startCrouch(e));
        document.getElementById('btn-crouch').addEventListener('mouseup', (e) => stopCrouch(e));


        // FUNZIONI GIOCO
        function startGame() {
            document.getElementById('start-screen').classList.add('hidden');
            document.getElementById('mobile-controls').style.display = 'flex'; // Mostra controlli
            resetVariables();
            state.running = true;
            loop();
        }

        function resetVariables() {
            state.player.y = canvas.height - GROUND_HEIGHT - state.player.originalH;
            state.player.dy = 0;
            state.player.h = state.player.originalH;
            state.player.crouching = false;
            state.score = 0;
            state.frameCount = 0;
            speed = 6;
            state.obstacles = [];
            document.getElementById('score-hud').innerText = "0";
        }

        function resetGame() {
            document.getElementById('lose-screen').classList.add('hidden');
            startGame();
        }

        function loop() {
            if(!state.running) return;
            requestAnimationFrame(loop);
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            state.frameCount++;
            // Aumento difficolt√† graduale
            if(state.frameCount % 500 === 0) speed += 0.5;
            
            // Punteggio
            if(state.frameCount % 10 === 0) {
                state.score++;
                document.getElementById('score-hud').innerText = state.score;
            }

            // FISICA PLAYER
            if(!state.player.grounded) {
                state.player.dy += GRAVITY;
                state.player.y += state.player.dy;
            }

            let groundY = canvas.height - GROUND_HEIGHT;
            
            // Atterraggio
            if(state.player.y + state.player.h > groundY) {
                state.player.y = groundY - state.player.h;
                state.player.dy = 0;
                state.player.grounded = true;
            }

            // GENERAZIONE OSTACOLI (Logica migliorata)
            spawnObstacles();

            // DISEGNO PAVIMENTO
            ctx.fillStyle = '#333';
            ctx.fillRect(0, groundY, canvas.width, GROUND_HEIGHT);
            ctx.fillStyle = '#00ff41'; // Linea verde
            ctx.fillRect(0, groundY, canvas.width, 2);

            // DISEGNO PLAYER
            ctx.save();
            // Se mi abbasso, schiaccio l'immagine
            if(state.player.crouching) {
                // Disegna schiacciato
                if(imgFace.complete && imgFace.naturalHeight !== 0) {
                     ctx.drawImage(imgFace, state.player.x, state.player.y, state.player.w, state.player.h);
                } else {
                    ctx.fillStyle = 'yellow'; // Colore diverso quando abbassato
                    ctx.fillRect(state.player.x, state.player.y, state.player.w, state.player.h);
                }
            } else {
                // Normale
                if(imgFace.complete && imgFace.naturalHeight !== 0) {
                    ctx.drawImage(imgFace, state.player.x, state.player.y, state.player.w, state.player.h);
                } else {
                    ctx.fillStyle = 'red';
                    ctx.fillRect(state.player.x, state.player.y, state.player.w, state.player.h);
                }
            }
            // Bordo Debug
            // ctx.strokeStyle = 'white'; ctx.strokeRect(state.player.x, state.player.y, state.player.w, state.player.h);
            ctx.restore();

            // GESTIONE OSTACOLI
            updateObstacles();
        }

        function spawnObstacles() {
            // Distanza minima tra ostacoli basata sulla velocit√† (evita ostacoli impossibili)
            let minGap = 50 + (speed * 18); // Pi√π vai veloce, pi√π spazio serve
            
            // Controlla distanza dall'ultimo ostacolo
            let lastObs = state.obstacles[state.obstacles.length - 1];
            let distance = lastObs ? canvas.width - lastObs.x : Infinity;

            if (distance > minGap) {
                // Probabilit√† di spawn (1 su 40 frame circa)
                if (Math.random() < 0.02) {
                    let type = Math.random() > 0.6 ? 'air' : 'ground';
                    let obsW = 40; 
                    let obsH = 40;
                    let obsY = canvas.height - GROUND_HEIGHT - obsH; // A terra

                    if(type === 'air') {
                        // In aria (devi abbassarti)
                        // Altezza tale che se salti sbatti, se stai dritto sbatti, se ti abbassi passi
                        obsY = canvas.height - GROUND_HEIGHT - 75; 
                        obsW = 50; obsH = 40;
                    }

                    state.obstacles.push({ x: canvas.width, y: obsY, w: obsW, h: obsH, type: type });
                }
            }
        }

        function updateObstacles() {
            for(let i = 0; i < state.obstacles.length; i++) {
                let obs = state.obstacles[i];
                obs.x -= speed;

                // Disegno
                if(obs.type === 'ground') {
                    ctx.fillStyle = '#ff3333'; // Ostacolo terra rosso
                    ctx.fillRect(obs.x, obs.y, obs.w, obs.h);
                } else {
                    ctx.fillStyle = '#00ffff'; // Ostacolo aria azzurro (Uccello/Prof)
                    ctx.fillRect(obs.x, obs.y, obs.w, obs.h);
                }

                // COLLISIONE
                // Riduciamo hitbox player leggermente per essere buoni
                let p = state.player;
                let buffer = 5; 
                
                if (p.x + buffer < obs.x + obs.w &&
                    p.x + p.w - buffer > obs.x &&
                    p.y + buffer < obs.y + obs.h &&
                    p.y + p.h - buffer > obs.y) {
                    gameOver();
                }

                // Pulizia
                if(obs.x + obs.w < 0) {
                    state.obstacles.splice(i, 1);
                    i--;
                }
            }
        }

        function gameOver() {
            state.running = false;
            document.getElementById('mobile-controls').style.display = 'none'; // Nascondi tasti
            document.getElementById('final-score').innerText = state.score;
            document.getElementById('lose-screen').classList.remove('hidden');
        }

        window.submitScore = function() {
            const name = document.getElementById('player-name').value.trim();
            if(!name) { alert("Inserisci un nome!"); return; }
            window.saveScoreToDb(name, state.score);
        }
    </script>
</body>
</html>
