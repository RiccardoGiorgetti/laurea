<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Dino Run: Laurea Edition</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=VT323&display=swap');

        /* LAYOUT GENERALE */
        body { 
            margin: 0; padding: 0; 
            overflow: hidden; background-color: #202124; 
            font-family: 'Segoe UI', sans-serif;
            user-select: none; -webkit-user-select: none;
            touch-action: none; -webkit-tap-highlight-color: transparent;
            display: flex; flex-direction: column; height: 100vh;
        }
        
        #game-wrapper {
            position: relative; flex-grow: 1; width: 100%;
            background: #202124; overflow: hidden;
            border-bottom: 4px solid #555;
        }
        
        canvas { display: block; width: 100%; height: 100%; }

        /* ZONA CONTROLLI */
        #controls-area {
            height: 250px; background: #111; display: none; 
            align-items: flex-start; justify-content: space-around;
            padding: 20px 10px 80px 10px; box-sizing: border-box;
            border-top: 2px solid #333;
        }

        .big-btn {
            width: 45%; height: 120px; border-radius: 25px;
            border: 4px solid #555; background: #2a2a2a; color: #fff;
            font-size: 40px; font-weight: bold; font-family: 'VT323', monospace;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 10px 0 #000; transition: transform 0.1s;
        }
        .big-btn:active { transform: translateY(10px); box-shadow: none; background: #444; }
        .btn-green { border-color: #00ff41; color: #00ff41; } 
        .btn-blue { border-color: #00ffff; color: #00ffff; } 
        
        /* MENU E UI */
        .ui-layer { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            z-index: 50; background: rgba(32, 33, 36, 0.95);
            padding: 20px; box-sizing: border-box; text-align: center;
        }

        /* COUNTDOWN OVERLAY */
        #countdown-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: none; align-items: center; justify-content: center;
            z-index: 60; background: rgba(0,0,0,0.5);
        }
        #countdown-text {
            font-family: 'VT323', monospace; font-size: 150px; color: #00ff41;
            text-shadow: 0 0 20px #00ff41;
        }

        h1 { color: #ff5555; font-size: 40px; margin: 0 0 10px 0; font-family: 'VT323', monospace; text-transform: uppercase; letter-spacing: 2px; }
        p { color: #9aa0a6; font-size: 16px; max-width: 400px; margin-bottom: 20px; line-height: 1.4; }

        /* CLASSIFICA SCROLLABILE */
        #leaderboard { 
            margin-top: 15px; width: 100%; max-width: 320px; 
            border: 1px solid #555; padding: 15px; border-radius: 8px; 
            background: #000; 
            height: 200px; overflow-y: auto;
        }
        #leaderboard::-webkit-scrollbar { width: 8px; }
        #leaderboard::-webkit-scrollbar-thumb { background: #555; border-radius: 4px; }
        
        .lb-row { 
            display: flex; justify-content: space-between; 
            color: #fff; font-family: 'VT323', monospace; font-size: 24px; 
            margin-bottom: 8px; border-bottom: 1px solid #333; padding-bottom: 4px;
        }
        .lb-row:first-child { color: #ffd700; font-weight: bold; border-bottom: 1px solid #ffd700; }
        .lb-row:nth-child(2) { color: #c0c0c0; }
        .lb-row:nth-child(3) { color: #cd7f32; }

        button.menu-btn { 
            background: #8ab4f8; color: #202124; border: none; 
            padding: 15px 50px; font-size: 28px; font-family: 'VT323', monospace;
            border-radius: 4px; cursor: pointer; margin-top: 10px; font-weight: bold;
        }
        input { 
            background: transparent; border: none; border-bottom: 2px solid #8ab4f8;
            color: white; font-size: 28px; padding: 5px; text-align: center;
            width: 220px; margin-bottom: 20px; font-family: 'VT323', monospace;
            text-transform: uppercase;
        }
        input:focus { outline: none; border-color: #00ff41; }
        .hidden { display: none !important; }
    </style>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getDatabase, ref, push, query, onValue } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDbtLlpj1CDnzYwPkhg1UGSV5AJMImq_Uk",
            authDomain: "laurea-ec890.firebaseapp.com",
            databaseURL: "https://laurea-ec890-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "laurea-ec890",
            storageBucket: "laurea-ec890.firebasestorage.app",
            messagingSenderId: "178551805840",
            appId: "1:178551805840:web:6fe00130736417b9f78515"
        };

        let db;
        try {
            const app = initializeApp(firebaseConfig);
            db = getDatabase(app);
        } catch (e) {
            alert("Errore Configurazione Firebase: " + e.message);
        }

        window.globalHighScore = 0;

        // SALVATAGGIO LOGICA ARCADE
        window.saveScoreToDb = function(name, score) {
            if(!db) return alert("Database non collegato!");
            const btn = document.getElementById('btn-save');
            btn.innerText = "Salvataggio..."; 
            btn.disabled = true;
            
            const numericScore = parseInt(score, 10);
            const cleanName = name.trim().toUpperCase();

            push(ref(db, 'laurea_party_scores'), { 
                name: cleanName, 
                score: numericScore, 
                date: Date.now() 
            })
            .then(() => {
                location.reload(); 
            })
            .catch((e) => { 
                alert("‚ùå ERRORE: " + e.code); 
                btn.disabled = false; 
                btn.innerText = "RIPROVA"; 
            });
        };

        // CARICAMENTO CLASSIFICA
        window.loadLeaderboard = function() {
            if(!db) return;
            const list = document.getElementById('lb-list');
            
            const q = query(ref(db, 'laurea_party_scores'));
            onValue(q, (snapshot) => {
                list.innerHTML = "";
                
                let bestScores = {};
                snapshot.forEach(c => {
                    let entry = c.val();
                    let n = entry.name || "ANON";
                    if (!bestScores[n] || entry.score > bestScores[n]) {
                        bestScores[n] = entry.score;
                    }
                });

                let uniqueData = Object.keys(bestScores).map(name => {
                    return { name: name, score: bestScores[name] };
                });
                
                uniqueData.sort((a,b) => b.score - a.score); 
                
                if(uniqueData.length === 0) {
                    list.innerHTML = "<div style='text-align:center; margin-top:20px;'>Nessun giocatore.<br>Sii il primo!</div>";
                    window.globalHighScore = 0;
                } else {
                    window.globalHighScore = uniqueData[0].score;
                    
                    uniqueData.forEach((entry, i) => {
                        const d = document.createElement('div');
                        d.className = 'lb-row';
                        let n = entry.name.substring(0, 10);
                        d.innerHTML = `<span>${i+1}. ${n}</span><span>${entry.score}</span>`;
                        list.appendChild(d);
                    });
                }
            });
        };
        loadLeaderboard();
    </script>
</head>
<body>

    <div id="game-wrapper">
        <canvas id="gameCanvas"></canvas>

        <div id="start-screen" class="ui-layer">
            <h1>üéì DINO RUN<br>LAUREA EDITION</h1>
            <p>Non farti bocciare: i professori volano alto, schiacciati a terra!</p>
            <button class="menu-btn" onclick="preStartGame()">INIZIA</button>
            <div id="leaderboard">
                <div style="text-align:center; border-bottom:1px solid #555; margin-bottom:10px; padding-bottom:5px; color:#aaa; font-family:'VT323'; font-size:24px;">üèÜ CLASSIFICA GENERALE</div>
                <div id="lb-list">Caricamento in corso...</div>
            </div>
        </div>

        <div id="countdown-layer">
            <div id="countdown-text">3</div>
        </div>

        <div id="lose-screen" class="ui-layer hidden">
            <h1 style="color:white">BOCCIATO!</h1>
            <p style="font-size:50px; color:#00ff41; font-family:'VT323'; margin:10px;">SCORE: <span id="final-score">0</span></p>
            
            <input type="text" id="player-name" placeholder="IL TUO NOME" maxlength="10">
            <button id="btn-save" class="menu-btn" onclick="submitScore()">SALVA RECORD</button>
            
            <br>
            <button onclick="resetGame()" style="background:none; border:none; color:#888; text-decoration:underline; margin-top:30px; font-size:18px; cursor:pointer;">Rigioca senza salvare</button>
        </div>
    </div>

    <div id="controls-area">
        <div class="big-btn btn-green" onmousedown="doJump()" ontouchstart="doJump(event)">‚¨ÜÔ∏è SALTA</div>
        <div class="big-btn btn-blue" onmousedown="startCrouch()" onmouseup="stopCrouch()" ontouchstart="startCrouch(event)" ontouchend="stopCrouch(event)">‚¨áÔ∏è GI√ô</div>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const imgFace = new Image();
        
        imgFace.src = 'face_500x500.png';

        ctx.imageSmoothingEnabled = true;
        ctx.imageSmoothingQuality = 'high';

        // AUDIO
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playSound(type) {
            if(audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            
            if (type === 'jump') {
                osc.type = 'square';
                osc.frequency.setValueAtTime(150, audioCtx.currentTime);
                osc.frequency.linearRampToValueAtTime(600, audioCtx.currentTime + 0.1);
                gain.gain.setValueAtTime(0.05, audioCtx.currentTime);
                gain.gain.linearRampToValueAtTime(0, audioCtx.currentTime + 0.1);
            } else if (type === 'score') {
                osc.type = 'sine';
                osc.frequency.setValueAtTime(1200, audioCtx.currentTime);
                gain.gain.setValueAtTime(0.05, audioCtx.currentTime);
                gain.gain.linearRampToValueAtTime(0, audioCtx.currentTime + 0.1);
            } else { 
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(200, audioCtx.currentTime);
                osc.frequency.linearRampToValueAtTime(50, audioCtx.currentTime + 0.4);
                gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
                gain.gain.linearRampToValueAtTime(0, audioCtx.currentTime + 0.4);
            }
            osc.start(); osc.stop(audioCtx.currentTime + 0.4); 
        }

        function resize() {
            canvas.width = document.getElementById('game-wrapper').offsetWidth;
            canvas.height = document.getElementById('game-wrapper').offsetHeight;
        }
        window.addEventListener('resize', resize);
        resize();

        // LOGICA GIOCO
        let gameRunning = false;
        let score = 0;
        let speed = 7; 
        let frame = 0;

        // FISICA PI√ô RAPIDA E SNAPPY
        const DINO = {
            x: 50, y: 0,
            w: 44, h: 47,
            standH: 47, crouchH: 30,
            dy: 0, 
            gravity: 1.5,
            jumpForce: -18,
            grounded: false, crouching: false
        };
        let dino = { ...DINO };
        let obstacles = [];
        let groundY = 0;

        function doJump(e) {
            if(e) e.preventDefault();
            if(gameRunning && dino.grounded) {
                dino.dy = dino.jumpForce;
                dino.grounded = false;
                dino.crouching = false;
                playSound('jump');
            }
        }
        function startCrouch(e) {
            if(e) e.preventDefault();
            if(gameRunning && dino.grounded) {
                dino.crouching = true;
                dino.h = dino.crouchH;
                dino.y += (dino.standH - dino.crouchH);
            } else if (gameRunning && !dino.grounded) {
                dino.dy += 10;
            }
        }
        function stopCrouch(e) {
            if(e) e.preventDefault();
            if(gameRunning) {
                dino.crouching = false;
                dino.y -= (dino.standH - dino.crouchH);
                dino.h = dino.standH;
            }
        }

        window.addEventListener('keydown', (e) => {
            if(e.code === 'Space' || e.code === 'ArrowUp') doJump();
            if(e.code === 'ArrowDown') startCrouch();
        });
        window.addEventListener('keyup', (e) => {
            if(e.code === 'ArrowDown') stopCrouch();
        });

        // DISEGNO DINO
        function drawDinoBody(x, y, w, h) {
            ctx.fillStyle = '#acacac';
            
            if(dino.crouching) {
                ctx.fillRect(x, y, 55, 30); 
                ctx.fillRect(x-10, y+5, 10, 15); 
            } else {
                ctx.fillRect(x, y, 40, 30); 
                ctx.fillRect(x-8, y+10, 8, 20); 
            }

            let legFrame = Math.floor(frame / 5) % 2;
            let legY = y + (dino.crouching ? 30 : 30);
            
            if(!dino.grounded) {
                ctx.fillRect(x+5, legY, 6, 10);
                ctx.fillRect(x+25, legY, 6, 10);
            } else {
                if(legFrame === 0) {
                    ctx.fillRect(x+5, legY, 6, 10); 
                    ctx.fillRect(x+25, legY, 6, 4); 
                } else {
                    ctx.fillRect(x+5, legY, 6, 4); 
                    ctx.fillRect(x+25, legY, 6, 10); 
                }
            }

            let headSize = 55;
            let headX = dino.crouching ? x + 40 : x + 10;
            let headY = dino.crouching ? y - 10 : y - 28;

            if(imgFace.complete && imgFace.naturalHeight !== 0) {
                ctx.save();
                ctx.beginPath();
                ctx.arc(headX + headSize/2, headY + headSize/2, headSize/2, 0, Math.PI * 2);
                ctx.clip();
                ctx.drawImage(imgFace, headX, headY, headSize, headSize);
                ctx.restore();
            } else {
                ctx.fillStyle = 'red';
                ctx.fillRect(headX, headY, headSize, headSize);
            }
        }

        // COUNTDOWN
        function preStartGame() {
            document.getElementById('start-screen').classList.add('hidden');
            document.getElementById('controls-area').style.display = 'flex';
            document.getElementById('countdown-layer').style.display = 'flex';
            
            let count = 3;
            const countText = document.getElementById('countdown-text');
            countText.innerText = count;

            const timer = setInterval(() => {
                count--;
                if(count > 0) {
                    countText.innerText = count;
                } else {
                    clearInterval(timer);
                    document.getElementById('countdown-layer').style.display = 'none';
                    startGame();
                }
            }, 1000);
        }

        function startGame() {
            if(audioCtx.state === 'suspended') audioCtx.resume();
            
            score = 0; speed = 7; frame = 0; obstacles = [];
            dino.y = 0; dino.dy = 0; dino.grounded = false; dino.crouching = false;
            groundY = canvas.height - 30;
            
            gameRunning = true;
            loop();
        }

        function resetGame() {
            document.getElementById('lose-screen').classList.add('hidden');
            preStartGame();
        }

        function loop() {
            if(!gameRunning) return;
            requestAnimationFrame(loop);
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            frame++;
            if(frame % 5 === 0) score++;
            if(score > 0 && score % 100 === 0 && score % 500 !== 0) playSound('score'); 
            
            // ACCELERAZIONE COSTANTE (Aumenta ogni 200 frame)
            if(frame % 200 === 0) speed += 0.5;

            // HUD
            ctx.fillStyle = '#acacac';
            ctx.font = "bold 28px 'VT323'";
            ctx.textAlign = "right";
            let hiStr = (window.globalHighScore > score ? window.globalHighScore : score).toString().padStart(5, '0');
            let scStr = score.toString().padStart(5, '0');
            ctx.fillText("HI " + hiStr + "  " + scStr, canvas.width - 20, 40);

            // FISICA
            if(!dino.grounded) {
                dino.dy += dino.gravity;
                dino.y += dino.dy;
            }
            let currentH = dino.crouching ? dino.crouchH : dino.standH;
            let totalH = currentH + 10; 
            
            if(dino.y + totalH > groundY) {
                dino.y = groundY - totalH;
                dino.dy = 0;
                dino.grounded = true;
            }

            drawDinoBody(dino.x, dino.y, dino.w, dino.h);

            // OSTACOLI (TEMPO DI CADUTA AUMENTATO)
            let minGap = 150 + (speed * 12); 
            let lastObs = obstacles[obstacles.length - 1];
            let dist = lastObs ? canvas.width - lastObs.x : Infinity;

            // frame > 150 = 2 secondi e mezzo prima del primo ostacolo
            if(frame > 150 && dist > minGap) { 
                if(Math.random() < 0.04) {
                    let type = Math.random() > 0.6 ? 'bird' : 'cactus';
                    // CACTUS
                    let w = 30; let h = 45; let y = groundY - h;
                    
                    if(type === 'bird') {
                        // UCCELLO RITOCCATO: POSIZIONATO PI√ô IN ALTO
                        // Ora la base √® a groundY - 65. Passi sotto solo se ti abbassi.
                        w = 50; h = 40; y = groundY - 65;
                    }

                    obstacles.push({ x: canvas.width, y: y, w: w, h: h, type: type });
                }
            }

            for(let i=0; i<obstacles.length; i++) {
                let obs = obstacles[i];
                obs.x -= speed;
                
                ctx.fillStyle = '#acacac';
                if(obs.type === 'cactus') {
                    ctx.fillRect(obs.x + 10, obs.y, 10, obs.h); 
                    ctx.fillRect(obs.x, obs.y+10, 5, 15); 
                    ctx.fillRect(obs.x+25, obs.y+5, 5, 15); 
                } else {
                    // DISEGNO UCCELLO "BLOCCO VOLANTE"
                    let wingY = (Math.floor(frame/8)%2===0) ? -10 : 5;
                    ctx.fillRect(obs.x, obs.y, obs.w, obs.h); // Corpo solido
                    ctx.fillRect(obs.x + 10, obs.y + 5 + wingY, 20, 10); // Ala
                    ctx.fillRect(obs.x - 5, obs.y + 10, 10, 10); // Testa
                }

                // COLLISIONE CHIRURGICA
                let pad = 6;
                let dh = dino.crouching ? dino.crouchH : dino.standH;
                
                let dinoTop = dino.y + pad;
                let dinoBottom = dino.y + dh + 10 - pad;
                let dinoLeft = dino.x + pad;
                let dinoRight = dino.x + 40 - pad;

                let obsLeft = obs.x + pad;
                let obsRight = obs.x + obs.w - pad;
                
                // IL MURO INVISIBILE: l'uccello blocca tutto dall'alto
                let obsTop = obs.type === 'bird' ? -1000 : obs.y + pad; 
                let obsBottom = obs.y + obs.h - pad;

                let headTop = dino.crouching ? dino.y - 10 : dino.y - 28;
                if(!dino.crouching) dinoTop = headTop; 

                if (dinoLeft < obsRight && dinoRight > obsLeft &&
                    dinoTop < obsBottom && dinoBottom > obsTop) {
                    gameOver();
                }
                
                if(obs.x + obs.w < 0) { obstacles.splice(i, 1); i--; }
            }

            ctx.fillRect(0, groundY, canvas.width, 2);
        }

        function gameOver() {
            gameRunning = false;
            playSound('die');
            document.getElementById('controls-area').style.display = 'none';
            document.getElementById('final-score').innerText = score;
            document.getElementById('lose-screen').classList.remove('hidden');
        }

        window.submitScore = function() {
            const name = document.getElementById('player-name').value.trim();
            if(!name) { alert("INSERISCI NOME"); return; }
            window.saveScoreToDb(name, score);
        }
    </script>
</body>
</html>
