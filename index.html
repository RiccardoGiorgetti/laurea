<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Dino Run: Laurea Edition</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=VT323&display=swap');

        /* RESET E STILE BASE */
        body { 
            margin: 0; overflow: hidden; background-color: #202124; 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            user-select: none; -webkit-user-select: none;
            touch-action: none; -webkit-tap-highlight-color: transparent;
        }
        
        #game-container { 
            position: relative; width: 100%; height: 100vh; 
            display: flex; justify-content: center; align-items: center;
        }
        
        canvas { display: block; width: 100%; height: 100%; }

        /* INTERFACCIA UTENTE */
        .ui-layer { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            z-index: 50; background: rgba(32, 33, 36, 0.9);
            padding: 20px; box-sizing: border-box; text-align: center;
        }

        /* MESSAGGI STILE CHROME */
        .icon-dino { font-size: 50px; margin-bottom: 10px; filter: grayscale(100%); }
        h1 { font-size: 24px; color: #ff5555; margin: 10px 0; font-weight: 500; }
        p { color: #9aa0a6; font-size: 14px; line-height: 1.5; max-width: 400px; }
        .error-code { font-family: 'Courier New', monospace; color: #5f6368; font-size: 12px; margin-top: 15px; text-transform: uppercase; }

        /* BOTTONI E INPUT */
        button { 
            background: #8ab4f8; color: #202124; border: none; 
            padding: 12px 30px; font-size: 16px; font-weight: bold; 
            border-radius: 4px; cursor: pointer; margin-top: 20px; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        button:active { background: #669df6; transform: scale(0.98); }

        input { 
            background: transparent; border: none; border-bottom: 2px solid #8ab4f8;
            color: white; font-size: 20px; padding: 5px; text-align: center;
            width: 200px; margin-bottom: 20px; font-family: 'Courier New', monospace;
        }
        input:focus { outline: none; border-color: #aecbfa; }

        .hidden { display: none !important; }

        /* CLASSIFICA */
        #leaderboard { margin-top: 30px; width: 100%; max-width: 350px; border-top: 1px solid #5f6368; padding-top: 15px; }
        .lb-row { display: flex; justify-content: space-between; color: #9aa0a6; font-family: 'Courier New'; font-size: 13px; margin-bottom: 5px; }
        .lb-row:first-child { color: #8ab4f8; font-weight: bold; }

        /* CONTROLLI MOBILE */
        #mobile-controls {
            position: absolute; bottom: 0; left: 0; width: 100%; height: 100%;
            display: flex; z-index: 10;
        }
        .touch-zone { flex: 1; display: flex; align-items: flex-end; justify-content: center; padding-bottom: 40px; }
        .touch-label { 
            color: rgba(255,255,255,0.2); font-weight: bold; font-size: 20px; 
            border: 2px solid rgba(255,255,255,0.2); padding: 20px; border-radius: 50%;
            width: 60px; height: 60px; display: flex; align-items: center; justify-content: center;
        }
        #zone-left { border-right: 1px solid rgba(255,255,255,0.05); } /* Zona GIÃ™ */
        
    </style>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getDatabase, ref, push, query, orderByChild, limitToLast, onValue } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";

        // --- INCOLLA QUI LE TUE CHIAVI FIREBASE ---
        const firebaseConfig = {
            apiKey: "INCOLLA_LA_TUA_API_KEY",
            authDomain: "TUO-PROGETTO.firebaseapp.com",
            projectId: "TUO-PROGETTO",
            storageBucket: "TUO-PROGETTO.appspot.com",
            messagingSenderId: "NUMERO",
            appId: "CODICE_APP"
        };
        // ------------------------------------------

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        window.saveScoreToDb = function(name, score) {
            const btn = document.getElementById('btn-save');
            btn.innerText = "Salvataggio..."; btn.disabled = true;
            push(ref(db, 'scores_final_v3'), { name: name, score: score, date: Date.now() })
            .then(() => location.reload())
            .catch((e) => { alert("Errore DB: " + e); btn.disabled = false; btn.innerText = "Riprova"; });
        };

        window.loadLeaderboard = function() {
            const q = query(ref(db, 'scores_final_v3'), orderByChild('score'), limitToLast(5));
            onValue(q, (snapshot) => {
                const list = document.getElementById('lb-list');
                list.innerHTML = "";
                let data = [];
                snapshot.forEach(c => data.push(c.val()));
                data.sort((a,b) => b.score - a.score);
                if(data.length === 0) list.innerHTML = "<div class='lb-row'>Nessun record</div>";
                data.forEach((entry, i) => {
                    const d = document.createElement('div');
                    d.className = 'lb-row';
                    let name = entry.name ? entry.name.substring(0, 10).toUpperCase() : "ANON";
                    d.innerHTML = `<span>${i+1}. ${name}</span><span>${entry.score.toString().padStart(5,'0')}</span>`;
                    list.appendChild(d);
                });
            });
        };
        loadLeaderboard();
    </script>
</head>
<body>

    <div id="game-container">
        <canvas id="gameCanvas"></canvas>

        <div id="start-screen" class="ui-layer">
            <div class="icon-dino">ðŸ¦–</div>
            <h1>Connessione Laurea Assente</h1>
            <p>Impossibile contattare il server della tesi.<br>Aiuta Riccardo a raggiungere la proclamazione.</p>
            <div class="error-code">ERR_LAUREA_TIMEOUT</div>
            
            <button onclick="startGame()">INIZIA CORSA</button>

            <div id="leaderboard">
                <div style="font-size:12px; color:#5f6368; margin-bottom:5px;">SYSTEM_LOGS (TOP 5)</div>
                <div id="lb-list">Loading...</div>
            </div>
        </div>

        <div id="lose-screen" class="ui-layer hidden">
            <h1 style="color: #9aa0a6;">GAME OVER</h1>
            <p style="font-family:'Courier New'; font-size:24px; color:white; font-weight:bold; margin-bottom:30px;">SCORE: <span id="final-score">00000</span></p>
            
            <input type="text" id="player-name" placeholder="INSERISCI NOME" maxlength="10">
            <br>
            <button id="btn-save" onclick="submitScore()">SALVA RECORD</button>
            <br>
            <button onclick="resetGame()" style="background:transparent; border:1px solid #5f6368; color:#9aa0a6; margin-top:15px; font-size:14px;">Riprova senza salvare</button>
        </div>

        <div id="mobile-controls" class="hidden">
            <div id="zone-left" class="touch-zone" onmousedown="startCrouch()" onmouseup="stopCrouch()" ontouchstart="startCrouch(event)" ontouchend="stopCrouch(event)">
                <div class="touch-label">GIÃ™</div>
            </div>
            <div id="zone-right" class="touch-zone" onmousedown="doJump()" ontouchstart="doJump(event)">
                <div class="touch-label">SU</div>
            </div>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const imgFace = new Image();
        imgFace.src = 'face.png'; // FOTO CARICATA SU GITHUB

        // GESTIONE ALTA RISOLUZIONE (RETINA)
        let scale = 1;
        function resize() {
            scale = window.devicePixelRatio || 1;
            canvas.width = window.innerWidth * scale;
            canvas.height = window.innerHeight * scale;
            ctx.scale(scale, scale);
        }
        window.addEventListener('resize', resize);
        resize();

        // CONFIGURAZIONE
        let gameRunning = false;
        let score = 0;
        let speed = 6;
        let frame = 0;

        const DINO = {
            x: 50, y: 0,
            w: 44, h: 47, // Dimensioni in piedi
            standW: 44, standH: 47,
            crouchW: 55, crouchH: 30, // Dimensioni abbassato
            dy: 0,
            jumpForce: -13,
            gravity: 0.8,
            grounded: false,
            crouching: false
        };
        let dino = { ...DINO };
        let obstacles = [];
        let groundY = 0;

        // --- CONTROLLI ---
        function doJump(e) {
            if(e) e.preventDefault();
            if(gameRunning && dino.grounded && !dino.crouching) {
                dino.dy = dino.jumpForce;
                dino.grounded = false;
            }
        }

        function startCrouch(e) {
            if(e) e.preventDefault();
            if(gameRunning && dino.grounded) {
                dino.crouching = true;
                dino.h = dino.crouchH;
                dino.w = dino.crouchW;
                dino.y += (dino.standH - dino.crouchH); // Sposta giÃ¹ subito
            }
        }

        function stopCrouch(e) {
            if(e) e.preventDefault();
            if(gameRunning && dino.crouching) {
                dino.crouching = false;
                dino.y -= (dino.standH - dino.crouchH); // Torna su
                dino.h = dino.standH;
                dino.w = dino.standW;
            }
        }

        // TASTIERA PC
        window.addEventListener('keydown', (e) => {
            if(e.code === 'Space' || e.code === 'ArrowUp') doJump();
            if(e.code === 'ArrowDown') startCrouch();
        });
        window.addEventListener('keyup', (e) => {
            if(e.code === 'ArrowDown') stopCrouch();
        });

        // --- CORE GIOCO ---
        function startGame() {
            document.getElementById('start-screen').classList.add('hidden');
            document.getElementById('lose-screen').classList.add('hidden');
            document.getElementById('mobile-controls').classList.remove('hidden');
            
            // Reset Parametri
            score = 0; speed = 6; frame = 0; obstacles = [];
            dino.y = 0; dino.dy = 0; dino.grounded = false; dino.crouching = false;
            dino.h = dino.standH; dino.w = dino.standW;

            groundY = (canvas.height / scale) - 100; // Calcolo altezza pavimento
            
            gameRunning = true;
            loop();
        }

        function resetGame() {
            document.getElementById('lose-screen').classList.add('hidden');
            startGame();
        }

        // --- DISEGNO ---
        function drawDino(x, y, w, h) {
            ctx.fillStyle = '#acacac'; // Colore Dino Grigio

            // CORPO (Adattivo se abbassato)
            ctx.fillRect(x, y, w, h);

            // TESTA (La tua Faccia)
            // Se Ã¨ abbassato, la testa va spostata in avanti e in basso
            let headSize = 34;
            let headX = dino.crouching ? x + w - 20 : x + w - 25;
            let headY = dino.crouching ? y + 2 : y - 10;

            if(imgFace.complete && imgFace.naturalHeight !== 0) {
                ctx.save();
                ctx.beginPath();
                ctx.arc(headX + headSize/2, headY + headSize/2, headSize/2, 0, Math.PI * 2);
                ctx.closePath();
                ctx.clip(); // <--- RITAGLIO CIRCOLARE
                ctx.drawImage(imgFace, headX, headY, headSize, headSize);
                ctx.restore();
            } else {
                ctx.fillStyle = '#ff5555'; // Testa rossa se manca foto
                ctx.fillRect(headX, headY, headSize, headSize);
            }
        }

        function drawObstacle(obs) {
            if(obs.type === 'cactus') {
                ctx.fillStyle = '#acacac';
                ctx.fillRect(obs.x, obs.y, obs.w, obs.h);
            } else {
                // Uccello (Bird)
                ctx.fillStyle = '#acacac';
                let wingY = (Math.floor(frame / 10) % 2 === 0) ? -10 : 0;
                ctx.fillRect(obs.x, obs.y + 10, obs.w, 15); // Corpo
                ctx.fillRect(obs.x + 10, obs.y + 5 + wingY, 10, 10); // Ala
            }
        }

        function loop() {
            if(!gameRunning) return;
            requestAnimationFrame(loop);
            
            // Pulisci Canvas
            let cw = canvas.width / scale;
            let ch = canvas.height / scale;
            ctx.clearRect(0, 0, cw, ch);

            frame++;
            if(frame % 5 === 0) score++;
            if(frame % 500 === 0) speed += 0.5;

            // HUD
            ctx.fillStyle = '#acacac';
            ctx.font = "bold 20px 'Courier New'";
            ctx.textAlign = "right";
            ctx.fillText(score.toString().padStart(5, '0'), cw - 20, 40);

            // FISICA DINO
            if(!dino.grounded) {
                dino.dy += dino.gravity;
                dino.y += dino.dy;
            }

            if(dino.y + dino.h > groundY) {
                dino.y = groundY - dino.h;
                dino.dy = 0;
                dino.grounded = true;
            }

            drawDino(dino.x, dino.y, dino.w, dino.h);

            // GESTIONE OSTACOLI
            let minGap = 200 + (speed * 15);
            let lastObs = obstacles[obstacles.length - 1];
            let dist = lastObs ? cw - lastObs.x : Infinity;

            if(dist > minGap) {
                if(Math.random() < 0.03) {
                    let type = Math.random() > 0.7 ? 'bird' : 'cactus';
                    let obsH = type === 'cactus' ? 40 + Math.random() * 20 : 30;
                    let obsW = type === 'cactus' ? 25 : 40;
                    let obsY = groundY - obsH;

                    if(type === 'bird') {
                        // Uccello: deve essere evitabile abbassandosi
                        // Altezza testa dino in piedi: ~ groundY - 50
                        // Altezza testa dino abbassato: ~ groundY - 30
                        // Mettiamo l'uccello a groundY - 45 cosÃ¬ colpisce la testa in piedi ma non da abbassato
                        obsY = groundY - 50; 
                    }

                    obstacles.push({ x: cw, y: obsY, w: obsW, h: obsH, type: type });
                }
            }

            for(let i=0; i<obstacles.length; i++) {
                let obs = obstacles[i];
                obs.x -= speed;
                drawObstacle(obs);

                // COLLISIONE (Hitbox Precisa)
                let pad = 5;
                // La testa Ã¨ la parte piÃ¹ vulnerabile
                // Se Ã¨ un uccello, controlliamo collisione testa
                if (dino.x + pad < obs.x + obs.w - pad &&
                    dino.x + dino.w - pad > obs.x + pad &&
                    dino.y + pad < obs.y + obs.h - pad &&
                    dino.y + dino.h - pad > obs.y + pad) {
                    
                    gameOver();
                }

                if(obs.x + obs.w < 0) { obstacles.splice(i, 1); i--; }
            }

            // PAVIMENTO
            ctx.fillRect(0, groundY, cw, 2);
        }

        function gameOver() {
            gameRunning = false;
            document.getElementById('mobile-controls').classList.add('hidden'); // Nascondi controlli
            document.getElementById('final-score').innerText = score.toString().padStart(5, '0');
            document.getElementById('lose-screen').classList.remove('hidden');
        }

        window.submitScore = function() {
            const name = document.getElementById('player-name').value.trim();
            if(!name) { alert("INSERISCI UN NOME"); return; }
            window.saveScoreToDb(name, score);
        }
    </script>
</body>
</html>
