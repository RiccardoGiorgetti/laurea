<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Run Riccardo Run</title>
    <style>
        /* STILE GRAFICO */
        body { 
            margin: 0; 
            overflow: hidden; 
            background-color: #000; 
            font-family: 'Verdana', sans-serif; 
            touch-action: none; /* Impedisce lo zoom su mobile */
            user-select: none;
        }
        
        #game-container { 
            position: relative; 
            width: 100vw; 
            height: 100vh; 
            background: linear-gradient(180deg, #111 0%, #000 100%); 
            overflow: hidden;
        }
        
        canvas { 
            display: block; 
            width: 100%; 
            height: 100%; 
        }

        /* PUNTEGGIO IN ALTO A DESTRA */
        #score-hud {
            position: absolute;
            top: 20px;
            right: 20px;
            color: #00ff41; /* Verde Hacker */
            font-size: 32px;
            font-weight: bold;
            font-family: 'Courier New', monospace;
            z-index: 10;
            text-shadow: 0 0 10px rgba(0,255,65,0.5);
        }

        /* MENU E SCHERMATE */
        .ui-layer { 
            position: absolute; 
            top: 0; left: 0;
            width: 100%; 
            height: 100%; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            z-index: 20; 
            background: rgba(0,0,0,0.85); 
            backdrop-filter: blur(5px); 
        }
        
        h1 { color: #fff; font-size: 38px; text-transform: uppercase; margin-bottom: 10px; text-align: center; font-weight: 900; letter-spacing: 2px; }
        p { color: #ccc; margin-bottom: 30px; text-align: center; font-size: 16px; max-width: 90%; }
        
        /* BOTTONI */
        button { 
            background: #00ff41; 
            border: none; 
            padding: 15px 40px; 
            color: #000; 
            font-size: 20px; 
            font-weight: bold; 
            border-radius: 50px; 
            cursor: pointer; 
            box-shadow: 0 0 15px rgba(0, 255, 65, 0.4); 
            transition: transform 0.1s; 
            text-transform: uppercase;
            margin-top: 10px;
        }
        button:active { transform: scale(0.95); background: #00cc33; }

        .hidden { display: none !important; }

        /* CAMPO INSERIMENTO NOME */
        input { 
            padding: 15px; 
            font-size: 18px; 
            text-align: center; 
            border-radius: 10px; 
            border: 2px solid #333; 
            background: #222;
            color: white;
            margin-bottom: 20px; 
            width: 70%; 
            max-width: 300px;
        }

        /* CLASSIFICA BOX */
        #leaderboard-box { 
            background: rgba(255,255,255,0.08); 
            width: 85%; 
            max-width: 400px; 
            padding: 15px; 
            border-radius: 15px; 
            max-height: 250px; 
            overflow-y: auto; 
            text-align: left; 
            border: 1px solid #333;
            margin-top: 20px;
        }
        .row { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #444; color: #ccc; font-size: 14px; font-family: monospace; }
        .row:first-child { color: #ffd700; font-weight: bold; font-size: 16px; } /* Oro */
        .row:nth-child(2) { color: #c0c0c0; } /* Argento */
        .row:nth-child(3) { color: #cd7f32; } /* Bronzo */
    </style>

    <script type="module">
        // Importiamo le librerie direttamente da Google (non serve npm)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getDatabase, ref, push, query, orderByChild, limitToLast, onValue } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";

        // --- LA TUA CONFIGURAZIONE (INSERITA CORRETTAMENTE) ---
        const firebaseConfig = {
            apiKey: "AIzaSyDbtLlpj1CDnzYwPkhg1UGSV5AJMImq_Uk",
            authDomain: "laurea-ec890.firebaseapp.com",
            projectId: "laurea-ec890",
            storageBucket: "laurea-ec890.firebasestorage.app",
            messagingSenderId: "178551805840",
            appId: "1:178551805840:web:6fe00130736417b9f78515"
        };
        // ------------------------------------------------------

        // Inizializza Firebase
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // Funzione per salvare il punteggio
        window.saveScoreToDb = function(name, score) {
            const btn = document.getElementById('btn-save');
            btn.innerText = "Salvataggio...";
            btn.disabled = true;

            push(ref(db, 'scores_infinite'), { 
                name: name, 
                score: score, 
                date: Date.now() 
            }).then(() => {
                location.reload(); // Ricarica la pagina per aggiornare la classifica
            }).catch((e) => {
                alert("Errore: " + e);
                btn.innerText = "Riprova";
                btn.disabled = false;
            });
        };

        // Funzione per caricare la classifica
        window.loadLeaderboard = function() {
            const q = query(ref(db, 'scores_infinite'), orderByChild('score'), limitToLast(10));
            onValue(q, (snapshot) => {
                const list = document.getElementById('lb-list');
                list.innerHTML = "";
                let data = [];
                snapshot.forEach(c => data.push(c.val()));
                
                // Ordina dal pi√π alto al pi√π basso
                data.sort((a,b) => b.score - a.score); 
                
                if(data.length === 0) list.innerHTML = "<div style='text-align:center; padding:10px;'>Nessun record</div>";
                
                data.forEach((entry, i) => {
                    const d = document.createElement('div');
                    d.className = 'row';
                    let safeName = entry.name ? entry.name.substring(0, 12) : "Anonimo";
                    d.innerHTML = `<span>${i+1}. ${safeName}</span><span>${entry.score}</span>`;
                    list.appendChild(d);
                });
            });
        };
        
        // Carica la classifica all'avvio
        loadLeaderboard();
    </script>
</head>
<body>

    <div id="score-hud">0</div>

    <div id="game-container">
        <canvas id="gameCanvas"></canvas>

        <div id="start-screen" class="ui-layer">
            <h1>INFINITE RUN</h1>
            <p>Tocca per saltare.<br>Resisti pi√π che puoi!</p>
            <button onclick="startGame()">GIOCA</button>
            
            <div id="leaderboard-box">
                <div style="text-align:center; color:#00ff41; border-bottom:1px solid #444; margin-bottom:10px; padding-bottom:5px; font-weight:bold;">üèÜ TOP PLAYERS</div>
                <div id="lb-list">Caricamento...</div>
            </div>
        </div>

        <div id="lose-screen" class="ui-layer hidden">
            <h1 style="color:#ff3333; font-size: 42px;">GAME OVER</h1>
            <p style="font-size: 20px; color: white;">Punteggio: <span id="final-score" style="font-weight:bold; color:#00ff41">0</span></p>
            
            <p style="font-size: 14px; max-width: 80%; margin-top:0; opacity: 0.8;">Grazie per aver condiviso questo traguardo con me.</p>

            <input type="text" id="player-name" placeholder="IL TUO NOME" maxlength="10">
            <button id="btn-save" onclick="submitScore()">SALVA RECORD</button>
            
            <button onclick="resetGame()" style="background:transparent; border:1px solid #555; color:#aaa; font-size:14px; padding:10px 20px; margin-top:15px;">Rigioca senza salvare</button>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        
        // Immagine Faccia
        const imgFace = new Image();
        imgFace.src = 'face.png'; // Assicurati di caricare questo file su GitHub!

        function resize() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }
        window.addEventListener('resize', resize);
        resize();

        // CONFIGURAZIONE VARIABILI
        const GRAVITY = 0.7;
        const JUMP_FORCE = -13; 
        let BASE_SPEED = 6;
        let speed = BASE_SPEED;
        
        let state = {
            running: false,
            score: 0,
            frameCount: 0,
            player: { x: 50, y: 0, dy: 0, size: 50, rotation: 0, grounded: false },
            obstacles: []
        };

        // GESTIONE INPUT (Touch & Click)
        function handleInput(e) {
            // Se clicco su bottoni o input, non saltare
            if(e.target.tagName === 'BUTTON' || e.target.tagName === 'INPUT') return;
            
            // Se tocco lo schermo, previeni lo scroll
            if(e.type === 'touchstart') e.preventDefault();
            
            if(state.running && state.player.grounded) {
                state.player.dy = JUMP_FORCE;
                state.player.grounded = false;
            }
        }

        window.addEventListener('mousedown', handleInput);
        window.addEventListener('touchstart', handleInput, {passive: false});
        window.addEventListener('keydown', (e) => { if(e.code==='Space') handleInput(e); });

        // FUNZIONI GIOCO
        function startGame() {
            document.getElementById('start-screen').classList.add('hidden');
            resetVariables();
            state.running = true;
            loop();
        }

        function resetVariables() {
            state.player.y = canvas.height - 100;
            state.player.dy = 0;
            state.player.rotation = 0;
            state.score = 0;
            state.frameCount = 0;
            speed = BASE_SPEED;
            state.obstacles = [];
            document.getElementById('score-hud').innerText = "0";
        }

        function resetGame() {
            document.getElementById('lose-screen').classList.add('hidden');
            resetVariables();
            state.running = true;
            loop();
        }

        function loop() {
            if(!state.running) return;
            requestAnimationFrame(loop);
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            state.frameCount++;
            
            // AUMENTO DIFFICOLT√Ä: Ogni 600 frame aumenta velocit√†
            if(state.frameCount % 600 === 0) speed += 0.5;
            
            // PUNTEGGIO: Ogni 10 frame +1 punto
            if(state.frameCount % 10 === 0) {
                state.score++;
                document.getElementById('score-hud').innerText = state.score;
            }

            // FISICA GIOCATORE
            state.player.dy += GRAVITY;
            state.player.y += state.player.dy;

            let groundY = canvas.height - 50;
            
            if(state.player.y + state.player.size > groundY) {
                state.player.y = groundY - state.player.size;
                state.player.dy = 0;
                state.player.grounded = true;
                state.player.rotation = 0; 
            } else {
                state.player.rotation += 0.15; // Ruota quando salta
            }

            // GENERAZIONE OSTACOLI
            // Random tra 90 e 150 frame
            if(state.frameCount % Math.floor(Math.random() * 60 + 90) === 0) {
                let type = Math.random() > 0.5 ? 'spike' : 'block';
                state.obstacles.push({
                    x: canvas.width,
                    y: groundY,
                    w: type === 'spike' ? 40 : 50,
                    h: type === 'spike' ? 60 : 50,
                    type: type
                });
            }

            // DISEGNO GIOCATORE (Faccia o Quadrato Rosso)
            ctx.save();
            ctx.translate(state.player.x + state.player.size/2, state.player.y + state.player.size/2);
            ctx.rotate(state.player.rotation);
            
            if(imgFace.complete && imgFace.naturalHeight !== 0) {
                // Se l'immagine c'√®, disegna cerchio con faccia
                ctx.beginPath();
                ctx.arc(0, 0, state.player.size/2, 0, Math.PI * 2);
                ctx.clip();
                ctx.drawImage(imgFace, -state.player.size/2, -state.player.size/2, state.player.size, state.player.size);
            } else {
                // Fallback: Quadrato Rosso se non trova l'immagine
                ctx.fillStyle = '#ff0000';
                ctx.fillRect(-state.player.size/2, -state.player.size/2, state.player.size, state.player.size);
            }
            ctx.restore();
            
            // Bordo Bianco al giocatore
            ctx.strokeStyle = '#fff';
            ctx.lineWidth = 3;
            ctx.beginPath();
            ctx.arc(state.player.x + state.player.size/2, state.player.y + state.player.size/2, state.player.size/2, 0, Math.PI * 2);
            ctx.stroke();

            // DISEGNO E GESTIONE OSTACOLI
            for(let i = 0; i < state.obstacles.length; i++) {
                let obs = state.obstacles[i];
                obs.x -= speed;

                if(obs.type === 'spike') {
                    ctx.fillStyle = '#ff3333'; // Spine rosse
                    ctx.beginPath();
                    ctx.moveTo(obs.x, obs.y);
                    ctx.lineTo(obs.x + obs.w/2, obs.y - obs.h);
                    ctx.lineTo(obs.x + obs.w, obs.y);
                    ctx.fill();
                } else {
                    ctx.fillStyle = '#00ff41'; // Blocchi verdi
                    ctx.fillRect(obs.x, obs.y - obs.h, obs.w, obs.h);
                }

                // COLLISIONE (Hitbox leggermente ridotta per essere gentili)
                let pPadding = 8; 
                let ox = obs.x; let oy = obs.y - obs.h;
                
                if (state.player.x + pPadding < ox + obs.w &&
                    state.player.x + state.player.size - pPadding > ox &&
                    state.player.y + pPadding < oy + obs.h &&
                    state.player.y + state.player.size - pPadding > oy) {
                    gameOver();
                }

                // Rimuovi ostacolo se uscito dallo schermo
                if(obs.x + obs.w < 0) { state.obstacles.splice(i, 1); i--; }
            }

            // DISEGNO PAVIMENTO
            ctx.fillStyle = '#333';
            ctx.fillRect(0, groundY, canvas.width, 10);
        }

        function gameOver() {
            state.running = false;
            document.getElementById('final-score').innerText = state.score;
            document.getElementById('lose-screen').classList.remove('hidden');
        }

        window.submitScore = function() {
            const name = document.getElementById('player-name').value.trim();
            if(!name) { alert("Inserisci un nome!"); return; }
            window.saveScoreToDb(name, state.score);
        }
    </script>
</body>
</html>
